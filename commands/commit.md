---
allowed-tools: Bash(git:*), Bash(mkdir:*), Bash(cat:*), Bash(tee:*), Bash(test:*), SequentialThinking
description: Create semantic commits, push changes, and generate comprehensive PR descriptions. Enforces safe branching (never commit to main/master).
---

## Role

Developer organizing changes into clean, conventional commits with comprehensive PR documentation.

## Pre-check: Branch Safety

1. **Check Current Branch**:

   ```bash
   git branch --show-current
   ```

2. **Rules**:

   * Never commit directly to `main` or `master`.
   * If on `main`/`master`:

     * Propose a new branch name (e.g., `feature/<description>`).
     * Confirm with the user before creating and checking out the new branch.
   * If already on a local branch:

     * Confirm with the user whether to continue on the same branch or switch to a different one.

3. **Branch Creation (if needed)**:

   ```bash
   git checkout -b <new-branch-name>
   ```

---

## Execution

1. **Identify Active Tickets**:

   ```bash
   # Find tickets with current branch
   CURRENT_BRANCH=$(git branch --show-current)

   # Find tickets associated with this branch
   cat .sage/.sage/tickets/index.json | jq -r "
     .tickets[] |
     select(.git.branch == \"$CURRENT_BRANCH\") |
     .id
   "

   # Or identify tickets from recent commits
   git log --oneline --since="1 day ago" | grep -oE '#[A-Z]+-[0-9]+'
   ```

2. **Analyze Changes**:

   ```bash
   git status --short
   git diff --stat
   git branch --show-current
   ```

3. **Group Files**: Use `SequentialThinking` to:

   * Identify logical change groups
   * Determine commit types and scopes
   * Extract ticket IDs from context
   * Order commits by dependency

4. **Create Commits** with Ticket References:

   ```bash
   # For each group, include ticket ID in commit message
   git add <files>
   git commit -m "type(scope): #TICKET-ID subject" -m "body

   Closes: #TICKET-ID"
   ```

5. **Update Ticket with Commit Info**:

   ```bash
   # Record final commits in ticket
   TICKET_ID="AUTH-001"
   COMMITS=$(git log --format="%H" origin/main..HEAD)

   # Append to .sage/tickets/[ID].md
   cat >> .sage/tickets/${TICKET_ID}.md <<EOF

   ## Final Commits
   $(git log --format="- [%h]: %s" origin/main..HEAD)
   EOF

   # Update .sage/.sage/tickets/index.json git.commits array
   ```

6. **Validate**: Check commit history:

   ```bash
   git log --oneline -10
   ```

7. **Push**:

   ```bash
   git push origin $(git branch --show-current)
   ```

8. **Generate PR Message** with Ticket Context:

   ```bash
   mkdir -p .docs
   tee .docs/PR_DESCRIPTION.md
   ```

---

## Commit Strategy

### Conventional Commit Format

```bash
<type>(<scope>): <subject>

<body>

<footer>
```

### Types

* **feat**: New feature
* **fix**: Bug fix
* **docs**: Documentation only
* **style**: Formatting, missing semicolons
* **refactor**: Code restructuring
* **perf**: Performance improvement
* **test**: Adding tests
* **chore**: Build, tools, dependencies

### Scoping Guidelines

* Use component/directory name (e.g., `auth`, `api`, `ui`)
* Use `*` for multiple scopes
* Omit scope if change is global

### Authorship Guidelines

**CRITICAL: NO AI ATTRIBUTION IN COMMITS**

* All commits are made on behalf of the developer ONLY
* **NEVER** include AI tool references, attribution, or co-authorship
* **NEVER** include footers like "Generated with Claude Code" or "Co-Authored-By: Claude"
* **NEVER** include phrases like "AI-assisted", "Claude-generated", "with Claude Code", etc.
* Commit messages should use first-person perspective when appropriate
* Git user.name and user.email reflect only the developer's identity

**PROHIBITED Examples (NEVER use these):**

```plaintext
‚ùå ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
‚ùå Co-Authored-By: Claude <noreply@anthropic.com>
‚ùå AI-assisted commit
‚ùå Created with help from Claude
‚ùå Generated by AI
```

**Correct Approach:**

```plaintext
‚úÖ feat(auth): add JWT validation

Implement JWT token validation with refresh token support.

Closes: #AUTH-001
```

Commits should read as if written entirely by the developer, with no mention of AI tools.

---

## Grouping Strategy

1. **Review all changes**: Understand full scope
2. **Identify atoms**: Find smallest logical units
3. **Group related**: Combine interdependent changes
4. **Order logically**: Dependencies first, then features

Decision tree:

* **Single concern?** ‚Üí One commit
* **Multiple features?** ‚Üí Separate commits
* **Feature + tests?** ‚Üí Same commit
* **Feature + docs?** ‚Üí Same commit
* **Unrelated fixes?** ‚Üí Separate commits
* **Refactor + feature?** ‚Üí Separate commits

---

## PR Message Template

```markdown
# [Type]: [Concise title]

## üé´ Tickets
- Closes #AUTH-001
- Related #AUTH-002
- Depends on #DB-001

## üéØ Purpose
[Why this change is needed - business value or problem solved]

**Ticket Context:**
- **AUTH-001**: [Ticket title and acceptance criteria summary]

## üìù Changes
### Added
- Feature/functionality added (per AUTH-001 acceptance criteria)
### Changed
- Modified behavior or implementation
### Fixed
- Bug fixes and corrections
### Removed
- Deprecated or deleted code

## üîß Technical Details
**Approach:**
[High-level implementation strategy from ticket context]

**Key Files:**
- `path/to/file1.ts` - [what changed]
- `path/to/file2.ts` - [what changed]

**Dependencies:**
- [Any new dependencies added]
- [Version updates]

**Ticket Implementation:**
- Followed spec: `docs/specs/auth/spec.md`
- Used architecture from: `docs/specs/auth/plan.md`
- Implemented per: `docs/breakdown/auth/breakdown.md`

## üß™ Testing
**Test Coverage:**
- [ ] Unit tests added/updated
- [ ] Integration tests added/updated
- [ ] E2E tests added/updated
- [ ] Manual testing completed

**Acceptance Criteria Met:**
- [x] [Criterion 1 from ticket]
- [x] [Criterion 2 from ticket]
- [x] [Criterion 3 from ticket]

**Test Scenarios:**
1. [Scenario 1]
2. [Scenario 2]

## üìä Impact
**Performance:**
- [Any performance implications]

**Breaking Changes:**
- [ ] No breaking changes
- [ ] Breaking changes (describe below)

**Migration Required:**
- [ ] No migration needed
- [ ] Migration steps provided

## üîó References
- Tickets: #AUTH-001, #AUTH-002
- Spec: docs/specs/auth/spec.md
- Plan: docs/specs/auth/plan.md
- Breakdown: docs/breakdown/auth/breakdown.md

## üì∏ Screenshots/Demo
[If UI changes, include screenshots or GIF]

## ‚úÖ Checklist
- [ ] Code follows project style guidelines
- [ ] Tests pass locally
- [ ] Documentation updated
- [ ] No console errors/warnings
- [ ] Reviewed own code
- [ ] All ticket acceptance criteria met
- [ ] Ticket marked COMPLETED in .sage/.sage/tickets/index.json
- [ ] Ready for review

## üìã Review Notes
[Any specific areas reviewers should focus on]

---

### Commits in this PR
- `abc123f` feat(auth): #AUTH-001 add JWT validation
- `def456a` test(auth): #AUTH-001 add validation tests
- `ghi789b` docs(auth): #AUTH-001 update API docs

### Ticket Status
- **AUTH-001**: IN_PROGRESS ‚Üí COMPLETED
- Branch: feature/auth-001
- Duration: [X hours]
```

---

## Validation Checklist

Before pushing:

* [ ] All commits follow conventional format with ticket IDs
* [ ] Commit messages include `#TICKET-ID` references
* [ ] Ticket IDs match active tickets in `.sage/.sage/tickets/index.json`
* [ ] Commit messages are descriptive
* [ ] No WIP or temp commits
* [ ] Related changes grouped together
* [ ] Tests committed with features
* [ ] No sensitive data in commits
* [ ] No references to AI tools or assistance
* [ ] **Not committing to `main` or `master`**
* [ ] Branch name matches ticket convention (`feature/ticket-id`)
* [ ] Tickets updated with commit SHAs
* [ ] Ticket acceptance criteria met

## Ticket Integration

**Commit Message Format with Tickets:**

```plaintext
feat(component): #TICKET-ID implement feature

Detailed description of implementation.

Addresses acceptance criteria:
- Criterion 1
- Criterion 2

Closes: #TICKET-ID
```

**Multiple Tickets in One Commit:**

```plaintext
feat(auth): #AUTH-001 #AUTH-002 implement JWT and OAuth

Implements both JWT validation and OAuth integration
as these features are tightly coupled.

Closes: #AUTH-001, #AUTH-002
```

**Ticket Reference in Footer:**

```plaintext
Closes: #TICKET-ID
Refs: #RELATED-ID
Depends-On: #DEPENDENCY-ID
```

## Post-Commit Actions

After pushing:

1. **Update Ticket States**: If not done by `/implement`, manually update `.sage/.sage/tickets/index.json`
2. **Run /sync**: Push ticket updates to GitHub
3. **Create PR**: Use generated `.docs/PR_DESCRIPTION.md`
4. **Link PR to Tickets**: Reference PR number in ticket markdown
