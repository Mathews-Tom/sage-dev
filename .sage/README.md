# .sage Directory

Configuration and state files for sage-dev enforcement system.

## ðŸŽ¯ Universal Skills - Alternative Interaction Model

**New in v2.6:** Sage-Dev is now available as portable Claude Skills that work across all LLM platforms (Claude, ChatGPT, Gemini). Skills provide the same expertise as slash commands but through natural language auto-discovery.

**Quick Start:**
```bash
./sage-skillify.sh  # Generates skills/*.zip files
# Upload to your LLM of choice
```

**Learn More:** See [docs/SKILLS_GUIDE.md](../docs/SKILLS_GUIDE.md) for installation and usage.

---

## Files

### Configuration

**`config.json`** - Language and setup configuration

- Auto-generated during setup via `sage-setup.sh`
- Defines selected programming language (python/javascript/typescript)
- Sets enforcement level (STRICT/BALANCED/PROTOTYPE)
- Tracks configuration timestamp

Example:

```json
{
  "language": "python",
  "enforcement_level": "BALANCED",
  "configured_at": "2025-01-15T10:30:00Z"
}
```

**`enforcement.json`** - Agent enforcement configuration

- Copy from `enforcement.json.template` to customize
- Defines enforcement level (STRICT/BALANCED/PROTOTYPE)
- Enables/disables agents
- Configures auto-fix behavior
- Sets up git hooks

**`secrets-allowlist.json`** - Allowlisted secrets

- Patterns that are safe to commit (test data, examples)
- Requires justification and expiration date
- Auto-generated by secret-scanner agent

### State Files

**`enforcement-report.md`** - Latest enforcement run report

- Generated by `/enforce` command
- Lists violations by agent
- Shows auto-fix results
- Provides recommendations

**`checkpoint.json`** - System checkpoint metadata

- Created before destructive operations
- Used by `/rollback` command
- Contains git stash ID and timestamp

**`coverage-history.json`** - Test coverage history

- Tracks coverage over time
- Enables regression detection
- Generated by test-coverage agent

**`import-graph.json`** - Import dependency graph

- Maps module dependencies
- Detects circular imports
- Generated by import-enforcer agent

**`velocity-metrics.json`** - Development velocity metrics

- Time per ticket
- Completion rate
- Estimation accuracy
- Generated by `/estimate` command

### Setup

1. **Initialize enforcement config:**

   ```bash
   cp .sage/enforcement.json.template .sage/enforcement.json
   ```

2. **Edit configuration:**

   ```bash
   # Set enforcement level
   STRICT      - Zero tolerance, all agents enabled
   BALANCED    - Core agents, warnings for non-critical
   PROTOTYPE   - Minimal checks, security only
   ```

3. **Enable git hooks:**

   ```bash
   # Pre-commit hook
   cat > .git/hooks/pre-commit <<'EOF'
   #!/bin/bash
   /enforce --pipeline=pre-commit
   exit $?
   EOF
   chmod +x .git/hooks/pre-commit
   ```

### Enforcement Levels

**STRICT:**

- All agents enabled
- Auto-fix enabled
- Fail-fast: true
- Blocks on any violation
- Best for: Production code, critical projects

**BALANCED (Default):**

- Core agents enabled
- Auto-fix enabled
- Fail-fast: false
- Blocks on critical violations only
- Best for: Most projects, standard development

**PROTOTYPE:**

- Security agents only
- Auto-fix disabled
- Fail-fast: false
- Logs violations, no blocking
- Best for: Rapid prototyping, experiments

### Agent Configuration

Edit `enforcement.json` to configure individual agents:

```json
{
  "agent_config": {
    "type-enforcer": {
      "enabled": true,
      "auto_fix": true,
      "run_mypy": true,
      "mypy_strict": true
    },

    "secret-scanner": {
      "enabled": true,
      "block_on_detection": true,
      "scan_git_history": false
    }
  }
}
```

### Exemptions

Exclude files/paths from enforcement:

```json
{
  "exemptions": {
    "paths": [
      "tests/**",
      "**/migrations/**"
    ],
    "files": [
      "conftest.py"
    ],
    "patterns": [
      "# noqa: enforcement"
    ]
  }
}
```

### Git Hooks

Configure automatic enforcement:

```json
{
  "hooks": {
    "pre_commit": {
      "enabled": true,
      "agents": ["secret-scanner", "bs-enforce"],
      "fail_fast": true
    },

    "pre_push": {
      "enabled": true,
      "agents": ["test-coverage"],
      "fail_fast": true
    }
  }
}
```

### Secrets Allowlist

Create `.sage/secrets-allowlist.json`:

```json
{
  "allowlist": [
    {
      "pattern": "AKIA1234EXAMPLEKEY",
      "file": "tests/fixtures/test_data.py",
      "justification": "Test fixture, not real credential",
      "added_by": "developer@example.com",
      "added_at": "2025-01-15",
      "expires_at": "2026-01-15"
    }
  ]
}
```

### Common Commands

```bash
# Run enforcement pipeline
/enforce

# Run specific pipeline
/enforce --pipeline=pre-commit

# Strict mode with auto-fix
/enforce --strict --auto-fix

# Dry run (preview only)
/enforce --dry-run

# View latest report
cat .sage/enforcement-report.md

# Check coverage history
cat .sage/coverage-history.json | jq '.[]'

# View import graph
cat .sage/import-graph.json
```

### Troubleshooting

**Issue: Enforcement always fails**

- Check `.sage/enforcement-report.md` for details
- Try: `/enforce --dry-run` to preview without blocking
- Lower strictness: Edit `enforcement.json`, set `"level": "BALANCED"`

**Issue: Auto-fix not working**

- Verify: `"auto_fix_enabled": true` in `enforcement.json`
- Run with: `/enforce --auto-fix`
- Check syntax errors prevent auto-fix

**Issue: Too many warnings**

- Adjust thresholds in `enforcement.json`:

  ```json
  {
    "thresholds": {
      "max_warnings": 100
    }
  }
  ```

**Issue: Agent not running**

- Check enabled: `jq '.enabled_agents[]' .sage/enforcement.json`
- Verify agent exists: `ls agents/`
- Check agent registry: `cat agents/index.json`

### Integration

**CI/CD:**

```yaml
# .github/workflows/enforce.yml
- name: Run enforcement
  run: |
    cp .sage/enforcement.json.template .sage/enforcement.json
    /enforce --strict
```

**Pre-commit framework:**

```yaml
# .pre-commit-config.yaml
- repo: local
  hooks:
    - id: sage-enforce
      name: Sage-Dev Enforcement
      entry: /enforce --pipeline=pre-commit
      language: system
      pass_filenames: false
```

### Files Generated by Agents

| Agent | Output File | Purpose |
|-------|-------------|---------|
| test-coverage | `.sage/coverage-history.json` | Coverage tracking |
| import-enforcer | `.sage/import-graph.json` | Dependency graph |
| secret-scanner | `.sage/secrets-detected.log` | Secret detections |
| All agents | `.sage/enforcement-report.md` | Unified report |

### Best Practices

1. **Start with BALANCED level** - Adjust to STRICT once comfortable
2. **Enable auto-fix** - Saves time on formatting issues
3. **Configure git hooks** - Automatic enforcement prevents issues
4. **Review reports** - Check `.sage/enforcement-report.md` regularly
5. **Update allowlists** - Remove expired entries periodically
6. **Track coverage** - Monitor `.sage/coverage-history.json` for trends
7. **Commit .sage/enforcement.json** - Share config with team
8. **Gitignore state files** - Don't commit reports, logs, history

### .gitignore

Add to `.gitignore`:

```gitignore
# Sage-Dev state files (don't commit)
.sage/enforcement-report.md
.sage/checkpoint*.json
.sage/coverage-history.json
.sage/import-graph.json
.sage/velocity-metrics.json
.sage/secrets-detected.log
.sage/rollback.log
.sage/stream-velocity.log
.sage/burndown-data.json

# Keep config (commit these)
# .sage/enforcement.json
# .sage/secrets-allowlist.json
```
