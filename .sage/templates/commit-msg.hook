#!/bin/sh
#
# Git commit-msg hook - Strips AI attribution from commit messages
# Auto-installed by sage-setup.sh
#
# This hook enforces the NO AI ATTRIBUTION policy by automatically
# removing any AI tool references from commit messages.
#

COMMIT_MSG_FILE=$1

# AI attribution patterns to remove
AI_PATTERNS=(
    "🤖 Generated with \[Claude Code\].*"
    "🤖 Generated with Claude Code.*"
    "Co-Authored-By: Claude <.*"
    "Co-authored-by: Claude <.*"
    "AI-assisted commit"
    "Created with help from Claude"
    "Generated by AI"
    "With Claude Code"
    "Claude-generated"
    "Assisted by AI"
)

# Read original commit message
ORIGINAL_MSG=$(cat "$COMMIT_MSG_FILE")

# Strip AI attribution patterns
CLEANED_MSG="$ORIGINAL_MSG"
for pattern in "${AI_PATTERNS[@]}"; do
    CLEANED_MSG=$(echo "$CLEANED_MSG" | grep -v "$pattern" || true)
done

# Remove empty lines at the end
CLEANED_MSG=$(echo "$CLEANED_MSG" | sed -e :a -e '/^\s*$/d;N;ba')

# Write cleaned message back
echo "$CLEANED_MSG" > "$COMMIT_MSG_FILE"

# Log if attribution was stripped (optional)
if [ "$ORIGINAL_MSG" != "$CLEANED_MSG" ]; then
    echo "⚠️  AI attribution removed from commit message" >&2
fi

exit 0
